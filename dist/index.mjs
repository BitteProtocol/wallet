import {createAction}from'@near-wallet-selector/wallet-utils';import {providers,keyStores,connect,transactions}from'near-api-js';import {KeyPair,serialize}from'near-api-js/lib/utils';var y="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTUiIGhlaWdodD0iOTUiIHZpZXdCb3g9IjAgMCA5NSA5NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xLjc3NjE3IDU5LjE4MjZMNjIuNzIyNyA2My4zMTNDNjMuMTE4NSA2My40MzA5IDYzLjQ3ODggNjMuNjQ1NiA2My43NzA4IDYzLjkzNzdDNjQuMDYyOSA2NC4yMjk3IDY0LjI3NzUgNjQuNTg5OSA2NC4zOTU0IDY0Ljk4NThMNjguNTI1OSA3OC44NTU1QzY4LjY3ODcgNzkuMzY4NiA2OC45OTMyIDc5LjgxODYgNjkuNDIyNCA4MC4xMzg3QzY5Ljg1MTYgODAuNDU4NyA3MC4zNzI3IDgwLjYzMTYgNzAuOTA4MiA4MC42MzE2QzcxLjQ0MzYgODAuNjMxNiA3MS45NjQ3IDgwLjQ1ODcgNzIuMzkzOSA4MC4xMzg3QzcyLjgyMzEgNzkuODE4NiA3My4xMzc2IDc5LjM2ODYgNzMuMjkwNCA3OC44NTU1TDc3LjQyMDkgNjQuOTg1OEM3Ny41Mzg4IDY0LjU4OTkgNzcuNzUzNCA2NC4yMjk3IDc4LjA0NTUgNjMuOTM3N0M3OC4zMzc2IDYzLjY0NTYgNzguNjk3OCA2My40MzA5IDc5LjA5MzYgNjMuMzEzTDkyLjk2MzMgNTkuMTgyNkM5My40NzY0IDU5LjAyOTcgOTMuOTI2NSA1OC43MTUzIDk0LjI0NjYgNTguMjg2MUM5NC41NjY2IDU3Ljg1NjggOTQuNzM5NSA1Ny4zMzU3IDk0LjczOTUgNTYuODAwM0M5NC43Mzk1IDU2LjI2NDkgOTQuNTY2NiA1NS43NDM4IDk0LjI0NjYgNTUuMzE0NkM5My45MjY1IDU0Ljg4NTMgOTMuNDc2NCA1NC41NzA5IDkyLjk2MzMgNTQuNDE4MUw3OS4wOTM3IDUwLjI4NzZDNzguNjk3OCA1MC4xNjk3IDc4LjMzNzYgNDkuOTU1IDc4LjA0NTUgNDkuNjYzQzc3Ljc1MzUgNDkuMzcwOSA3Ny41Mzg4IDQ5LjAxMDcgNzcuNDIwOSA0OC42MTQ4TDczLjI5MDQgMzQuNzQ1MkM3My4xMzc2IDM0LjIzMiA3Mi44MjMyIDMzLjc4MTkgNzIuMzkzOSAzMy40NjE5QzcxLjk2NDcgMzMuMTQxOSA3MS40NDM2IDMyLjk2OSA3MC45MDgyIDMyLjk2OUM3MC4zNzI4IDMyLjk2OSA2OS44NTE3IDMzLjE0MTkgNjkuNDIyNCAzMy40NjE5QzY4Ljk5MzIgMzMuNzgxOSA2OC42Nzg4IDM0LjIzMiA2OC41MjYgMzQuNzQ1Mkw2NC4zOTU0IDQ4LjYxNDhDNjQuMjc3NiA0OS4wMTA3IDY0LjA2MjkgNDkuMzcwOSA2My43NzA4IDQ5LjY2M0M2My40Nzg4IDQ5Ljk1NSA2My4xMTg1IDUwLjE2OTcgNjIuNzIyNyA1MC4yODc2TDEuNzc2MTggNTQuNDE4MUMxLjI2MzA1IDU0LjU3MDkgMC44MTI5NTYgNTQuODg1MyAwLjQ5MjkyIDU1LjMxNDZDMC4xNzI4ODQgNTUuNzQzOCAyLjI0NzU1ZS0wNiA1Ni4yNjQ5IDAgNTYuODAwM0MtMi4yNDc1MWUtMDYgNTcuMzM1NyAwLjE3Mjg4NyA1Ny44NTY4IDAuNDkyOTIgNTguMjg2MUMwLjgxMjk1MyA1OC43MTUzIDEuMjYzMDMgNTkuMDI5NyAxLjc3NjE3IDU5LjE4MjZaIiBmaWxsPSJibGFjayIvPgo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTMyLjE2MzcgMjkuNDg2OEw0MC4zNTc4IDMxLjkyNzFDNDAuNTkxNyAzMS45OTY3IDQwLjgwNDUgMzIuMTIzNiA0MC45NzcgMzIuMjk2MUM0MS4xNDk2IDMyLjQ2ODcgNDEuMjc2NCAzMi42ODE1IDQxLjM0NjEgMzIuOTE1NEw0My43ODYzIDQxLjEwOTVDNDMuODc2NiA0MS40MTI2IDQ0LjA2MjQgNDEuNjc4NSA0NC4zMTYgNDEuODY3NkM0NC41Njk2IDQyLjA1NjcgNDQuODc3NCA0Mi4xNTg4IDQ1LjE5MzcgNDIuMTU4OEM0NS41MTAxIDQyLjE1ODggNDUuODE3OSA0Mi4wNTY3IDQ2LjA3MTUgNDEuODY3NkM0Ni4zMjUxIDQxLjY3ODUgNDYuNTEwOSA0MS40MTI2IDQ2LjYwMTEgNDEuMTA5NUw0OS4wNDE0IDMyLjkxNTRDNDkuMTExMSAzMi42ODE1IDQ5LjIzNzkgMzIuNDY4NyA0OS40MTA0IDMyLjI5NjFDNDkuNTgzIDMyLjEyMzYgNDkuNzk1OCAzMS45OTY3IDUwLjAyOTcgMzEuOTI3MUw1OC4yMjM4IDI5LjQ4NjhDNTguNTI2OSAyOS4zOTY2IDU4Ljc5MjggMjkuMjEwOCA1OC45ODE5IDI4Ljk1NzJDNTkuMTcxIDI4LjcwMzYgNTkuMjczMSAyOC4zOTU4IDU5LjI3MzEgMjguMDc5NEM1OS4yNzMxIDI3Ljc2MzEgNTkuMTcxIDI3LjQ1NTMgNTguOTgxOSAyNy4yMDE3QzU4Ljc5MjggMjYuOTQ4MSA1OC41MjY5IDI2Ljc2MjMgNTguMjIzOCAyNi42NzJMNTAuMDI5NiAyNC4yMzE3QzQ5Ljc5NTggMjQuMTYyMSA0OS41ODI5IDI0LjAzNTIgNDkuNDEwNCAyMy44NjI3QzQ5LjIzNzkgMjMuNjkwMiA0OS4xMTEgMjMuNDc3MyA0OS4wNDE0IDIzLjI0MzRMNDYuNjAxMSAxNS4wNDkzQzQ2LjUxMDggMTQuNzQ2MiA0Ni4zMjUgMTQuNDgwMyA0Ni4wNzE1IDE0LjI5MTJDNDUuODE3OSAxNC4xMDIxIDQ1LjUxIDE0IDQ1LjE5MzcgMTRDNDQuODc3NCAxNCA0NC41Njk1IDE0LjEwMjEgNDQuMzE1OSAxNC4yOTEyQzQ0LjA2MjMgMTQuNDgwMyA0My44NzY2IDE0Ljc0NjIgNDMuNzg2MyAxNS4wNDkzTDQxLjM0NiAyMy4yNDM0QzQxLjI3NjQgMjMuNDc3MyA0MS4xNDk1IDIzLjY5MDIgNDAuOTc3IDIzLjg2MjdDNDAuODA0NCAyNC4wMzUyIDQwLjU5MTYgMjQuMTYyMSA0MC4zNTc4IDI0LjIzMTdMMzIuMTYzNyAyNi42NzJDMzEuODYwNSAyNi43NjIyIDMxLjU5NDYgMjYuOTQ4IDMxLjQwNTUgMjcuMjAxNkMzMS4yMTY0IDI3LjQ1NTIgMzEuMTE0MyAyNy43NjMxIDMxLjExNDMgMjguMDc5NEMzMS4xMTQzIDI4LjM5NTggMzEuMjE2NCAyOC43MDM3IDMxLjQwNTUgMjguOTU3MkMzMS41OTQ2IDI5LjIxMDggMzEuODYwNSAyOS4zOTY2IDMyLjE2MzcgMjkuNDg2OFoiIGZpbGw9ImJsYWNrIi8+Cjwvc3ZnPgo=";var j=480,A=640,p=300,u=()=>({signedAccountId:localStorage.getItem("signedAccountId")||"",functionCallKey:JSON.parse(localStorage.getItem("functionCallKey")||"null")}),I=t=>{localStorage.setItem("signedAccountId",t.signedAccountId),localStorage.setItem("functionCallKey",JSON.stringify(t.functionCallKey));},C=(t,a)=>({walletUrl:t,network:a,provider:new providers.JsonRpcProvider({url:a.nodeUrl})}),U=t=>t.signedAccountId,f=t=>{if(t.functionCallKey)return KeyPair.fromString(t.functionCallKey.privateKey).getPublicKey()},Q=t=>!!t.signedAccountId,x=()=>{let t={signedAccountId:"",functionCallKey:null};return I(t),t},z=(t,{contractId:a,methodNames:n})=>{let r=new URL(window.location.href),e=new URL(`${t.walletUrl}/login/`);e.searchParams.set("success_url",r.href),e.searchParams.set("failure_url",r.href);let i=null;if(a){e.searchParams.set("contract_id",a);let s=KeyPair.fromRandom("ed25519");e.searchParams.set("public_key",s.getPublicKey().toString()),i={privateKey:s.toString(),contractId:a,methods:n||[]};}n&&n.forEach(s=>{e.searchParams.append("methodNames",s);});let o=u();return o.functionCallKey=i,I(o),{url:e.toString(),newState:o}},h=async(t,a,{contractId:n,methodNames:r})=>{let{url:e,newState:i}=z(t,{contractId:n,methodNames:r});return D(t,e,async o=>{let s=o,{public_key:c,account_id:l}=s;if(l){let M={...i,signedAccountId:l};return I(M),[{accountId:l,publicKey:c||""}]}throw new Error("Invalid response data from wallet")})},W=async(t,{message:a,nonce:n,recipient:r,callbackUrl:e,state:i})=>{let o=e||window.location.href;if(!o)throw new Error("BitteWallet: CallbackUrl is missing");let s=new URL(t.walletUrl);return s.pathname="sign-message",s.searchParams.append("message",a),s.searchParams.append("nonce",n.toString("base64")),s.searchParams.append("recipient",r),s.searchParams.append("callbackUrl",o),i&&s.searchParams.append("state",i),D(t,s.toString(),c=>({accountId:c?.signedRequest?.accountId||"",publicKey:c?.signedRequest?.publicKey||"",signature:c?.signedRequest?.signature||""}))},Y=async(t,a,{receiverId:n,actions:r})=>{let e=await t.provider.block({finality:"final"}),i=serialize.base_decode(e.header.hash);return transactions.createTransaction(a.signedAccountId,KeyPair.fromRandom("ed25519").getPublicKey(),n,0,r.map(o=>createAction(o)),Uint8Array.from(i))},P=(t,a,n)=>t.functionCallKey&&t.functionCallKey.contractId===a?n[0].type==="FunctionCall"&&n[0].params.deposit==="0"&&(t.functionCallKey.methods.length===0||t.functionCallKey.methods.includes(n[0].params.methodName)):false,b=async(t,a,{receiverId:n,actions:r})=>{let e=new keyStores.InMemoryKeyStore,i=KeyPair.fromString(a.functionCallKey.privateKey);return await e.setKey(t.network.networkId,a.signedAccountId,i),(await(await connect({...t.network,keyStore:e})).account(a.signedAccountId)).signAndSendTransaction({receiverId:n,actions:r.map(c=>createAction(c))})},K=(t,a)=>{let n=new URL(`${t.walletUrl}/sign-transaction`),r=JSON.stringify(a),e=encodeURIComponent(r);return n.searchParams.set("transactions_data",e),n.searchParams.set("callback_url",window.location.origin),n.toString()},T=async(t,a)=>{let n=K(t,a),r=(await D(t,n,e=>e.transactionHashes))?.split(",");if(!r)throw new Error("No transaction hashes received");return Promise.all(r.map(e=>t.provider.txStatus(e,"unused")))},v=async(t,a,{receiverId:n,actions:r})=>{if(r.length===1&&P(a,n,r))try{return await b(t,a,{receiverId:n,actions:r})}catch(o){console.warn("Failed to sign using key pair, falling back to wallet",o);}let e=await Y(t,a,{receiverId:n,actions:r});return (await T(t,[e]))[0]},B=async(t,a,n)=>T(t,n),Z=(t,a,n,r,e)=>async o=>{let s=o.data,c=new URL(o.origin),l=new URL(t.walletUrl);if(c.origin!==l.origin){console.warn("Ignoring message from different origin",c.origin);return}switch(s.status){case "success":r?.close(),a(e(s));break;case "failure":r?.close(),n(new Error(s.errorMessage||"Transaction failed"));break;default:console.warn("Unhandled message status:",s.status);}},D=(t,a,n)=>{let r=window.innerWidth||screen.width,e=window.innerHeight||screen.height,i=(r-j)/2,o=(e-A)/2,s=window.open(a,"BitteWallet",`width=${j},height=${A},top=${o},left=${i}`);if(!s)throw new Error("Popup window blocked. Please allow popups for this site.");return new Promise((c,l)=>{let M=Z(t,c,l,s,n);window.addEventListener("message",M);let g=setInterval(()=>{s.closed&&(window.removeEventListener("message",M),clearInterval(g),l(new Error("User closed the window")));},p);})},w=(t,a)=>{let n=C(t,a),r=u();return {getAccountId:()=>U(r),getPublicKey:()=>f(r),isSignedIn:()=>Q(r),signOut:()=>(r=x(),null),requestSignIn:async e=>{let i=await h(n,r,e);return r=u(),i},requestSignInUrl:e=>{let{url:i,newState:o}=z(n,e);return r=o,i},signMessage:e=>W(n,e),signAndSendTransaction:e=>v(n,r,e),signAndSendTransactions:e=>B(n,r,e)}};var O=(t,a)=>{if(a)return a;switch(t.networkId){case "mainnet":return "https://wallet.bitte.ai";case "testnet":return "https://testnet.wallet.bitte.ai";default:throw new Error("Invalid wallet url")}},R=async(t,a)=>({wallet:w(t.walletUrl,a)}),F=async({metadata:t,options:a,store:n,params:r,logger:e})=>{let i=await R(r,a.network),o=async()=>{let s=i.wallet.getAccountId(),c=i.wallet.getPublicKey();return [{accountId:s,publicKey:c?c.toString():""}]};return {async signIn({contractId:s,methodNames:c}){return i.wallet.isSignedIn()||await i.wallet.requestSignIn({contractId:s,methodNames:c}),o()},async signOut(){i.wallet.signOut();},async getAccounts(){return o()},async verifyOwner(){throw new Error(`Method not supported by ${t.name}`)},async signMessage({message:s,nonce:c,recipient:l,callbackUrl:M,state:g}){return e.log("sign message",{message:s}),await i.wallet.signMessage({message:s,nonce:c,recipient:l,callbackUrl:M,state:g})},async signAndSendTransaction({signerId:s,receiverId:c,actions:l}){e.log("signAndSendTransaction",{signerId:s,receiverId:c,actions:l});let{contract:M}=n.getState();if(!i.wallet.isSignedIn()||!M)throw new Error("Wallet not signed in");let g=i.wallet.getAccountId();if(s&&g!==s)throw new Error(`Signed in as ${g}, cannot sign for ${s}`);return console.log(l,"actions"),i.wallet.signAndSendTransaction({receiverId:c||M.contractId,actions:l})},async signAndSendTransactions({transactions:s}){if(e.log("signAndSendTransactions",{transactions:s}),!i.wallet.isSignedIn())throw new Error("Wallet not signed in");return i.wallet.signAndSendTransactions(s)},buildImportAccountsUrl(){return `${r.walletUrl}/batch-import`}}};function G({walletUrl:t,iconUrl:a=y,deprecated:n=false}={}){return async r=>({id:"bitte-wallet",type:"injected",metadata:{name:"Bitte Wallet",description:"NEAR wallet to store, buy, send and stake assets for DeFi.",iconUrl:a,deprecated:n,available:true,downloadUrl:O(r.options.network,t)},init:e=>F({...e,params:{walletUrl:O(r.options.network,t)}})})}
export{G as setupBitteWallet};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map