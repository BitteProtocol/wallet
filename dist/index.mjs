import {createAction}from'@near-wallet-selector/wallet-utils';import {providers,keyStores,connect}from'near-api-js';import {KeyPair}from'near-api-js/lib/utils/index.js';var j="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTUiIGhlaWdodD0iOTUiIHZpZXdCb3g9IjAgMCA5NSA5NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xLjc3NjE3IDU5LjE4MjZMNjIuNzIyNyA2My4zMTNDNjMuMTE4NSA2My40MzA5IDYzLjQ3ODggNjMuNjQ1NiA2My43NzA4IDYzLjkzNzdDNjQuMDYyOSA2NC4yMjk3IDY0LjI3NzUgNjQuNTg5OSA2NC4zOTU0IDY0Ljk4NThMNjguNTI1OSA3OC44NTU1QzY4LjY3ODcgNzkuMzY4NiA2OC45OTMyIDc5LjgxODYgNjkuNDIyNCA4MC4xMzg3QzY5Ljg1MTYgODAuNDU4NyA3MC4zNzI3IDgwLjYzMTYgNzAuOTA4MiA4MC42MzE2QzcxLjQ0MzYgODAuNjMxNiA3MS45NjQ3IDgwLjQ1ODcgNzIuMzkzOSA4MC4xMzg3QzcyLjgyMzEgNzkuODE4NiA3My4xMzc2IDc5LjM2ODYgNzMuMjkwNCA3OC44NTU1TDc3LjQyMDkgNjQuOTg1OEM3Ny41Mzg4IDY0LjU4OTkgNzcuNzUzNCA2NC4yMjk3IDc4LjA0NTUgNjMuOTM3N0M3OC4zMzc2IDYzLjY0NTYgNzguNjk3OCA2My40MzA5IDc5LjA5MzYgNjMuMzEzTDkyLjk2MzMgNTkuMTgyNkM5My40NzY0IDU5LjAyOTcgOTMuOTI2NSA1OC43MTUzIDk0LjI0NjYgNTguMjg2MUM5NC41NjY2IDU3Ljg1NjggOTQuNzM5NSA1Ny4zMzU3IDk0LjczOTUgNTYuODAwM0M5NC43Mzk1IDU2LjI2NDkgOTQuNTY2NiA1NS43NDM4IDk0LjI0NjYgNTUuMzE0NkM5My45MjY1IDU0Ljg4NTMgOTMuNDc2NCA1NC41NzA5IDkyLjk2MzMgNTQuNDE4MUw3OS4wOTM3IDUwLjI4NzZDNzguNjk3OCA1MC4xNjk3IDc4LjMzNzYgNDkuOTU1IDc4LjA0NTUgNDkuNjYzQzc3Ljc1MzUgNDkuMzcwOSA3Ny41Mzg4IDQ5LjAxMDcgNzcuNDIwOSA0OC42MTQ4TDczLjI5MDQgMzQuNzQ1MkM3My4xMzc2IDM0LjIzMiA3Mi44MjMyIDMzLjc4MTkgNzIuMzkzOSAzMy40NjE5QzcxLjk2NDcgMzMuMTQxOSA3MS40NDM2IDMyLjk2OSA3MC45MDgyIDMyLjk2OUM3MC4zNzI4IDMyLjk2OSA2OS44NTE3IDMzLjE0MTkgNjkuNDIyNCAzMy40NjE5QzY4Ljk5MzIgMzMuNzgxOSA2OC42Nzg4IDM0LjIzMiA2OC41MjYgMzQuNzQ1Mkw2NC4zOTU0IDQ4LjYxNDhDNjQuMjc3NiA0OS4wMTA3IDY0LjA2MjkgNDkuMzcwOSA2My43NzA4IDQ5LjY2M0M2My40Nzg4IDQ5Ljk1NSA2My4xMTg1IDUwLjE2OTcgNjIuNzIyNyA1MC4yODc2TDEuNzc2MTggNTQuNDE4MUMxLjI2MzA1IDU0LjU3MDkgMC44MTI5NTYgNTQuODg1MyAwLjQ5MjkyIDU1LjMxNDZDMC4xNzI4ODQgNTUuNzQzOCAyLjI0NzU1ZS0wNiA1Ni4yNjQ5IDAgNTYuODAwM0MtMi4yNDc1MWUtMDYgNTcuMzM1NyAwLjE3Mjg4NyA1Ny44NTY4IDAuNDkyOTIgNTguMjg2MUMwLjgxMjk1MyA1OC43MTUzIDEuMjYzMDMgNTkuMDI5NyAxLjc3NjE3IDU5LjE4MjZaIiBmaWxsPSJibGFjayIvPgo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTMyLjE2MzcgMjkuNDg2OEw0MC4zNTc4IDMxLjkyNzFDNDAuNTkxNyAzMS45OTY3IDQwLjgwNDUgMzIuMTIzNiA0MC45NzcgMzIuMjk2MUM0MS4xNDk2IDMyLjQ2ODcgNDEuMjc2NCAzMi42ODE1IDQxLjM0NjEgMzIuOTE1NEw0My43ODYzIDQxLjEwOTVDNDMuODc2NiA0MS40MTI2IDQ0LjA2MjQgNDEuNjc4NSA0NC4zMTYgNDEuODY3NkM0NC41Njk2IDQyLjA1NjcgNDQuODc3NCA0Mi4xNTg4IDQ1LjE5MzcgNDIuMTU4OEM0NS41MTAxIDQyLjE1ODggNDUuODE3OSA0Mi4wNTY3IDQ2LjA3MTUgNDEuODY3NkM0Ni4zMjUxIDQxLjY3ODUgNDYuNTEwOSA0MS40MTI2IDQ2LjYwMTEgNDEuMTA5NUw0OS4wNDE0IDMyLjkxNTRDNDkuMTExMSAzMi42ODE1IDQ5LjIzNzkgMzIuNDY4NyA0OS40MTA0IDMyLjI5NjFDNDkuNTgzIDMyLjEyMzYgNDkuNzk1OCAzMS45OTY3IDUwLjAyOTcgMzEuOTI3MUw1OC4yMjM4IDI5LjQ4NjhDNTguNTI2OSAyOS4zOTY2IDU4Ljc5MjggMjkuMjEwOCA1OC45ODE5IDI4Ljk1NzJDNTkuMTcxIDI4LjcwMzYgNTkuMjczMSAyOC4zOTU4IDU5LjI3MzEgMjguMDc5NEM1OS4yNzMxIDI3Ljc2MzEgNTkuMTcxIDI3LjQ1NTMgNTguOTgxOSAyNy4yMDE3QzU4Ljc5MjggMjYuOTQ4MSA1OC41MjY5IDI2Ljc2MjMgNTguMjIzOCAyNi42NzJMNTAuMDI5NiAyNC4yMzE3QzQ5Ljc5NTggMjQuMTYyMSA0OS41ODI5IDI0LjAzNTIgNDkuNDEwNCAyMy44NjI3QzQ5LjIzNzkgMjMuNjkwMiA0OS4xMTEgMjMuNDc3MyA0OS4wNDE0IDIzLjI0MzRMNDYuNjAxMSAxNS4wNDkzQzQ2LjUxMDggMTQuNzQ2MiA0Ni4zMjUgMTQuNDgwMyA0Ni4wNzE1IDE0LjI5MTJDNDUuODE3OSAxNC4xMDIxIDQ1LjUxIDE0IDQ1LjE5MzcgMTRDNDQuODc3NCAxNCA0NC41Njk1IDE0LjEwMjEgNDQuMzE1OSAxNC4yOTEyQzQ0LjA2MjMgMTQuNDgwMyA0My44NzY2IDE0Ljc0NjIgNDMuNzg2MyAxNS4wNDkzTDQxLjM0NiAyMy4yNDM0QzQxLjI3NjQgMjMuNDc3MyA0MS4xNDk1IDIzLjY5MDIgNDAuOTc3IDIzLjg2MjdDNDAuODA0NCAyNC4wMzUyIDQwLjU5MTYgMjQuMTYyMSA0MC4zNTc4IDI0LjIzMTdMMzIuMTYzNyAyNi42NzJDMzEuODYwNSAyNi43NjIyIDMxLjU5NDYgMjYuOTQ4IDMxLjQwNTUgMjcuMjAxNkMzMS4yMTY0IDI3LjQ1NTIgMzEuMTE0MyAyNy43NjMxIDMxLjExNDMgMjguMDc5NEMzMS4xMTQzIDI4LjM5NTggMzEuMjE2NCAyOC43MDM3IDMxLjQwNTUgMjguOTU3MkMzMS41OTQ2IDI5LjIxMDggMzEuODYwNSAyOS4zOTY2IDMyLjE2MzcgMjkuNDg2OFoiIGZpbGw9ImJsYWNrIi8+Cjwvc3ZnPgo=";var y=480,A=640,k=300,N=()=>({signedAccountId:localStorage.getItem("bitte:signedAccountId")||"",functionCallKey:JSON.parse(localStorage.getItem("bitte:functionCallKey")||"null")}),I=t=>{localStorage.setItem("bitte:signedAccountId",t.signedAccountId),localStorage.setItem("bitte:functionCallKey",JSON.stringify(t.functionCallKey));},E=(t,a)=>({walletUrl:t,network:a,provider:new providers.JsonRpcProvider({url:a.nodeUrl})}),C=t=>t.signedAccountId,p=t=>{if(t.functionCallKey)return KeyPair.fromString(t.functionCallKey.privateKey).getPublicKey()},U=t=>!!t.signedAccountId,Q=()=>{let t={signedAccountId:"",functionCallKey:null};return I(t),t},d=(t,{contractId:a,methodNames:e})=>{let r=new URL(window.location.href),n=new URL(`${t.walletUrl}/login/`);n.searchParams.set("success_url",r.href),n.searchParams.set("failure_url",r.href);let i=null;if(a){n.searchParams.set("contract_id",a);let s=KeyPair.fromRandom("ed25519");n.searchParams.set("public_key",s.getPublicKey().toString()),i={privateKey:s.toString(),contractId:a,methods:e||[]};}e&&e.forEach(s=>{n.searchParams.append("methodNames",s);});let o=N();return o.functionCallKey=i,I(o),{url:n.toString(),newState:o}},f=async(t,a,{contractId:e,methodNames:r})=>{let{url:n,newState:i}=d(t,{contractId:e,methodNames:r});return D(t,n,async o=>{let s=o,{public_key:c,account_id:l}=s;if(l){let M={...i,signedAccountId:l};return I(M),[{accountId:l,publicKey:c||""}]}throw new Error("Invalid response data from wallet")})},x=async(t,{message:a,nonce:e,recipient:r,callbackUrl:n,state:i})=>{let o=n||window.location.href;if(!o)throw new Error("BitteWallet: CallbackUrl is missing");let s=new URL(t.walletUrl);return s.pathname="sign-message",s.searchParams.append("message",a),s.searchParams.append("nonce",e.toString("base64")),s.searchParams.append("recipient",r),s.searchParams.append("callbackUrl",o),i&&s.searchParams.append("state",i),D(t,s.toString(),c=>({accountId:c?.signedRequest?.accountId||"",publicKey:c?.signedRequest?.publicKey||"",signature:c?.signedRequest?.signature||""}))},h=(t,a,e)=>t.functionCallKey&&t.functionCallKey.contractId===a?e[0].type==="FunctionCall"&&e[0].params.deposit==="0"&&(t.functionCallKey.methods.length===0||t.functionCallKey.methods.includes(e[0].params.methodName)):false,W=async(t,a,{receiverId:e,actions:r})=>{let n=new keyStores.InMemoryKeyStore,i=KeyPair.fromString(a.functionCallKey.privateKey);return await n.setKey(t.network.networkId,a.signedAccountId,i),(await(await connect({...t.network,keyStore:n})).account(a.signedAccountId)).signAndSendTransaction({receiverId:e,actions:r.map(c=>createAction(c))})},Y=(t,a)=>{let e=new URL(`${t.walletUrl}/sign-transaction`),r=JSON.stringify(a,(i,o)=>typeof o=="bigint"?o.toString():o),n=encodeURIComponent(r);return e.searchParams.set("transactions_data",n),e.searchParams.set("callback_url",window.location.origin),e.toString()},z=async(t,a)=>{let e=Y(t,a),r=(await D(t,e,n=>n.transactionHashes))?.split(",");if(!r)throw new Error("No transaction hashes received");return Promise.all(r.map(n=>t.provider.txStatus(n,"unused")))},P=async(t,a,{receiverId:e,actions:r})=>{if(r.length===1&&h(a,e,r))try{return await W(t,a,{receiverId:e,actions:r})}catch(i){console.warn("Failed to sign using key pair, falling back to wallet",i);}return (await z(t,[{signerId:a.signedAccountId,receiverId:e,actions:r}]))[0]},b=async(t,a,e)=>z(t,e),K=(t,a,e,r,n)=>async o=>{let s=o.data,c=new URL(o.origin),l=new URL(t.walletUrl);if(c.origin!==l.origin){console.warn("Ignoring message from different origin",c.origin);return}switch(s.status){case "success":r?.close(),a(n(s));break;case "failure":r?.close(),e(new Error(s.errorMessage||"Transaction failed"));break;default:console.warn("Unhandled message status:",s.status);}},D=(t,a,e)=>{let r=window.innerWidth||screen.width,n=window.innerHeight||screen.height,i=(r-y)/2,o=(n-A)/2,s=window.open(a,"BitteWallet",`width=${y},height=${A},top=${o},left=${i}`);if(!s)throw new Error("Popup window blocked. Please allow popups for this site.");return new Promise((c,l)=>{let M=K(t,c,l,s,e);window.addEventListener("message",M);let g=setInterval(()=>{s.closed&&(window.removeEventListener("message",M),clearInterval(g),l(new Error("User closed the window")));},k);})},T=(t,a)=>{let e=E(t,a),r=N();return {getAccountId:()=>C(r),getPublicKey:()=>p(r),isSignedIn:()=>U(r),signOut:()=>(r=Q(),null),requestSignIn:async n=>{let i=await f(e,r,n);return r=N(),i},requestSignInUrl:n=>{let{url:i,newState:o}=d(e,n);return r=o,i},signMessage:n=>x(e,n),signAndSendTransaction:n=>P(e,r,n),signAndSendTransactions:n=>b(e,r,n)}};var w=(t,a)=>{if(a)return a;if(!t)return "https://wallet.bitte.ai";switch(t.networkId){case "mainnet":return "https://wallet.bitte.ai";case "testnet":return "https://testnet.wallet.bitte.ai";default:return "https://wallet.bitte.ai"}},v=async(t,a)=>({wallet:T(t.walletUrl,a)}),B=async({metadata:t,options:a,store:e,params:r,logger:n})=>{let i=await v(r,a.network),o=async()=>{let s=i.wallet.getAccountId(),c=i.wallet.getPublicKey();return [{accountId:s,publicKey:c?c.toString():""}]};return {async signIn({contractId:s,methodNames:c}){return i.wallet.isSignedIn()||await i.wallet.requestSignIn({contractId:s,methodNames:c}),o()},async signOut(){i.wallet.signOut();},async getAccounts(){return o()},async verifyOwner(){throw new Error(`Method not supported by ${t.name}`)},async signMessage({message:s,nonce:c,recipient:l,callbackUrl:M,state:g}){return n.log("sign message",{message:s}),await i.wallet.signMessage({message:s,nonce:c,recipient:l,callbackUrl:M,state:g})},async signAndSendTransaction({signerId:s,receiverId:c,actions:l}){n.log("signAndSendTransaction",{signerId:s,receiverId:c,actions:l});let{contract:M}=e.getState();if(!i.wallet.isSignedIn()||!M)throw new Error("Wallet not signed in");let g=i.wallet.getAccountId();if(s&&g!==s)throw new Error(`Signed in as ${g}, cannot sign for ${s}`);return i.wallet.signAndSendTransaction({receiverId:c||M.contractId,actions:l})},async signAndSendTransactions({transactions:s}){if(n.log("signAndSendTransactions",{transactions:s}),!i.wallet.isSignedIn())throw new Error("Wallet not signed in");return i.wallet.signAndSendTransactions(s)},buildImportAccountsUrl(){return `${r.walletUrl}/batch-import`}}};function Z({walletUrl:t,iconUrl:a=j,deprecated:e=false}={}){return async r=>({id:"bitte-wallet",type:"injected",metadata:{name:"Bitte Wallet",description:"NEAR wallet to store, buy, send and stake assets for DeFi.",iconUrl:a,deprecated:e,available:true,downloadUrl:w(r.options.network,t)},init:n=>B({...n,params:{walletUrl:w(r.options.network,t)}})})}
export{Z as setupBitteWallet};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map